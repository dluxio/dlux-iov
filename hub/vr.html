<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DLUX - VR HUB</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="/css/custom.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <a-scene>
            <a-entity camera look-controls wasd-controls position="0 1.6 0"></a-entity>
            <a-entity id="menu" position="0 1.5 -3">
                <a-plane position="0 0 0" width="1" height="0.5" color="#7BC8A4" @click="selectSection('hub')"></a-plane>
                <a-text value="HUB" position="-0.4 0.1 0.1" scale="0.5 0.5 0.5"></a-text>
                <a-plane position="1.2 0 0" width="1" height="0.5" color="#7BC8A4" @click="selectSection('nfts')"></a-plane>
                <a-text value="NFTs" position="0.8 0.1 0.1" scale="0.5 0.5 0.5"></a-text>
                <a-plane position="2.4 0 0" width="1" height="0.5" color="#7BC8A4" @click="selectSection('dex')"></a-plane>
                <a-text value="DEX" position="2.0 0.1 0.1" scale="0.5 0.5 0.5"></a-text>
            </a-entity>
            <a-entity v-if="currentSection === 'hub'" position="-2 1.5 -5">
                <a-entity v-for="(post, index) in displayPosts" :key="post.url" :position="index * 2 + ' 0 0'">
                    <a-plane width="1.5" height="1" color="#FFFFFF" @click="showPostDetails(post)"></a-plane>
                    <a-text :value="post.title" position="-0.7 0.4 0.1" scale="0.4 0.4 0.4"></a-text>
                </a-entity>
            </a-entity>
            <a-entity id="postDetails" v-if="selectedPost" position="0 1.5 -4">
                <a-plane width="3" height="2" color="#FFFFFF"></a-plane>
                <a-text :value="selectedPost.title" position="-1.4 0.9 0.1" scale="0.7 0.7 0.7"></a-text>
                <a-text :value="selectedPost.preview" position="-1.4 0.5 0.1" scale="0.5 0.5 0.5" width="2.8"></a-text>
                <a-plane position="1.2 -0.8 0.1" width="0.5" height="0.3" color="#FF0000" @click="hidePostDetails"></a-plane>
                <a-text value="Close" position="1.1 -0.8 0.2" scale="0.3 0.3 0.3"></a-text>
            </a-entity>
        </a-scene>
    </div>
    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    currentSection: 'hub',
                    displayPosts: [],
                    selectedPost: null,
                    postSelect: {
                        entry: 'new',
                        types: {
                            VR: { checked: true, bitFlag: 1 },
                            AR: { checked: true, bitFlag: 2 },
                            XR: { checked: true, bitFlag: 4 },
                            APP: { checked: true, bitFlag: 8 },
                            '360': { checked: true, bitFlag: 16 },
                            '3D': { checked: true, bitFlag: 32 },
                            Audio: { checked: true, bitFlag: 64 },
                            Video: { checked: true, bitFlag: 128 },
                            Blog: { checked: false, bitFlag: 256 }
                        },
                        bitMask: 0,
                        new: { a: 10, o: 0, e: false, p: false }
                    },
                    posturls: {}
                };
            },
            methods: {
                selectSection(section) {
                    this.currentSection = section;
                    if (section === 'hub') {
                        this.getPosts();
                    }
                },
                showPostDetails(post) {
                    this.selectedPost = post;
                },
                hidePostDetails() {
                    this.selectedPost = null;
                },
                getPosts() {
                    let bitMask = 0;
                    for (let type in this.postSelect.types) {
                        if (this.postSelect.types[type].checked) {
                            bitMask += this.postSelect.types[type].bitFlag;
                        }
                    }
                    if (this.postSelect.bitMask !== bitMask) {
                        this.postSelect.bitMask = bitMask;
                        this.displayPosts = [];
                        this.postSelect.new.o = 0;
                        this.postSelect.new.e = false;
                    }

                    if (!this.postSelect.new.e && !this.postSelect.new.p) {
                        this.postSelect.new.p = true;
                        const url = `https://data.dlux.io/new?a=${this.postSelect.new.a}&o=${this.postSelect.new.o}&b=${bitMask}`;
                        fetch(url)
                            .then(r => r.json())
                            .then(res => {
                                this.postSelect.new.p = false;
                                this.postSelect.new.o += this.postSelect.new.a;
                                if (res.result.length < this.postSelect.new.a) {
                                    this.postSelect.new.e = true;
                                }
                                for (let i = 0; i < res.result.length; i++) {
                                    const key = `/@${res.result[i].author}/${res.result[i].permlink}`;
                                    if (!this.posturls[key]) {
                                        this.posturls[key] = res.result[i];
                                        this.getContent(res.result[i].author, res.result[i].permlink);
                                    }
                                    this.displayPosts.push(this.posturls[key]);
                                }
                            });
                    }
                },
                getContent(author, permlink) {
                    fetch('https://api.hive.blog', {
                        body: `{"jsonrpc":"2.0", "method":"condenser_api.get_content", "params":["${author}", "${permlink}"], "id":1}`,
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        method: "POST"
                    })
                    .then(r => r.json())
                    .then(res => {
                        const key = `/@${author}/${permlink}`;
                        this.posturls[key] = { ...this.posturls[key], ...res.result };
                        this.posturls[key].preview = this.removeMD(res.result.body).substr(0, 250);
                        this.displayPosts = this.displayPosts.map(post => 
                            post.url === key ? this.posturls[key] : post
                        );
                    });
                },
                removeMD(md) {
                    return md.replace(/<[^>]*>/g, '').replace(/\!\[.*?\]\(.*?\)/g, '');
                }
            },
            mounted() {
                this.getPosts();
            }
        });

        app.config.compilerOptions.isCustomElement = tag => tag.startsWith('a-');
        app.mount('#app');
    </script>
</body>
</html>
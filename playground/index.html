<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Frame Scene Editor</title>

    <!-- A-Frame core must load first -->
    <script src="/js/aframe.min.js"></script>
    
    <!-- A-Frame Components - load after core -->
    <script src="/js/aframe-extras.min.js"></script>
    <script src="/js/aframe-environment-component.min.js"></script>
    
    <!-- Model Viewer -->
    <script type="module" src="/js/model-viewer.min.js"></script>
    
    <!-- Additional styles -->
    <link rel="stylesheet" href="/css/custom.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/0f693ffc58.js" crossorigin="anonymous"></script>
    <!-- HLS.js for M3U8 video playback support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- IPFS Video Support -->
    <script type="module" src="/js/ipfs-video-init.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        /* Basic layout */
        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 200px;
            background: #1B1B1B;
            padding: 15px;
            overflow-y: auto;
            color: #fff;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .scene-container {
            flex: 1;
            position: relative;
        }

        .toolbar {
            padding: 10px;
            background: #1B1B1B;
        }

        /* A-Frame scene and code panel */
        #scene {
            width: 100%;
            height: 100%;
        }

        #code-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        /* Inspector related styles */
        body.aframe-inspector-opened .sidebar,
        body.aframe-inspector-opened .toolbar {
            display: none !important;
        }
        
        body:not(.aframe-inspector-opened) .toggle-edit {
            display: none;
        }
        
        body.aframe-inspector-opened .scene-container {
            margin-left: 0 !important;
            width: 100% !important;
        }
        
        /* Asset management */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            padding: 5px;
        }

        .asset-item {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        .asset-item:hover {
            border-color: #666;
        }

        .asset-item.active {
            border-color: #fff;
        }

        .preview-wrapper {
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .preview-wrapper img,
        .preview-wrapper video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Controls */
        .geometry-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .geometry-buttons button {
            width: 100%;
            padding: 8px 5px;
            background: #2c2c2c;
            border: 1px solid #3c3c3c;
            color: #fff;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            justify-content: center;
        }

        .geometry-buttons button:hover {
            background: #3c3c3c;
            border-color: #4c4c4c;
        }

        /* Utility classes */
        .hidden {
            display: none;
        }
    </style>

    <!-- Monaco Editor - load after everything else to avoid conflicts -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/editor/editor.main.min.css">
    <script>var require = { paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' } };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <div class="brand-header">
                <svg class="nav-logo" viewBox="0 0 333 333" xmlns="http://www.w3.org/2000/svg">
                    <polygon class="cls-1"
                        points="184.59 135.97 184.21 135.97 110.55 11.06 219.49 9.03 228.91 24.43 137.69 26.25 146.62 41 165.61 72.39 184.6 103.79 193.82 119.03 211.76 119.03 248.48 119.03 284.59 119.02 302.68 119.02 256.79 39.98 273.78 40.15 329.46 134.96 184.59 135.97" />
                    <polygon class="cls-2"
                        points="110.55 11.06 184.21 135.97 184.59 135.97 175.83 150.85 175.52 150.85 101.87 27.04 110.55 11.06" />
                    <polygon class="cls-3"
                        points="184.01 40.5 146.62 41 137.69 26.25 228.91 24.43 184.6 103.79 174.99 87.86 201.39 40.27 184.08 40.5 184.01 40.5" />
                    <polygon class="cls-1" points="56.71 41.63 74.44 41.74 148.19 166.21 129.63 166.16 56.71 41.63" />
                    <polygon class="cls-2"
                        points="85.44 214.65 102.95 182.4 111.45 166.74 102.39 151.26 83.85 119.57 65.61 88.41 56.48 72.79 11.43 152.31 2.99 137.56 56.71 41.63 129.63 166.16 60.3 293.15 3.54 200.14 12.08 184.24 59.71 262.05 67.94 246.89 85.44 214.65" />
                    <polygon class="cls-2"
                        points="184.08 40.5 201.39 40.27 174.99 87.86 184.6 103.79 165.61 72.39 184.01 40.5 184.08 40.5" />
                    <polygon class="cls-2"
                        points="211.76 118.76 256.63 39.89 256.79 39.98 302.68 119.02 284.59 119.02 284.59 118.95 266.04 87.37 256.42 71.01 230.02 118.48 211.76 118.76" />
                    <polygon class="cls-3"
                        points="56.48 72.79 65.61 88.41 65.55 88.45 47.66 120.4 38.4 136.96 92.7 135.78 102.16 151.4 11.43 152.5 11.43 152.31 56.48 72.79" />
                    <polygon class="cls-3"
                        points="256.42 71.01 266.04 87.37 265.75 87.54 248.48 118.39 248.48 119.03 211.76 119.03 211.76 118.76 230.02 118.48 256.42 71.01" />
                    <polygon class="cls-1"
                        points="83.85 119.57 102.39 151.26 102.16 151.4 92.7 135.78 38.4 136.96 47.66 120.4 47.95 120.56 83.29 119.89 83.85 119.57" />
                    <polygon class="cls-3"
                        points="175.83 150.85 184.59 135.97 329.46 134.96 320.41 150.21 175.83 150.85" />
                    <polygon class="cls-3"
                        points="129.63 166.16 148.19 166.21 148.38 166.53 78.48 292.56 60.3 293.15 129.63 166.16" />
                    <polygon class="cls-1"
                        points="48.62 214.87 67.94 246.89 59.71 262.05 12.08 184.24 102.95 182.4 94.06 198.74 39.65 199.99 48.59 214.81 48.62 214.87" />
                    <polygon class="cls-3"
                        points="102.95 182.4 85.44 214.65 48.62 214.87 48.59 214.81 39.65 199.99 94.06 198.74 102.95 182.4" />
                    <polygon class="cls-1"
                        points="175.84 182.61 319.13 180.4 330.01 196.91 185.61 198.39 175.84 182.61 175.84 182.61" />
                    <polygon class="cls-2"
                        points="175.47 182.61 175.84 182.61 175.84 182.61 185.61 198.39 113.76 323.97 104.73 308.18 175.47 182.61" />
                    <polygon class="cls-3"
                        points="167.45 261.43 149.16 293.24 140.56 308.18 231.79 307.99 222.72 323.59 113.76 323.97 185.61 198.39 330.01 196.91 276.31 291.28 259.33 291.82 303.59 213.44 284.52 213.57 249.4 213.81 230.83 213.93 212.56 214.06 194.63 214.18 185.75 229.62 167.45 261.43" />
                    <polygon class="cls-2"
                        points="212.56 214.06 230.83 213.93 258.27 260.81 267.49 244.22 284.52 213.57 303.59 213.44 259.33 291.82 259.17 291.92 212.56 214.06" />
                    <polygon class="cls-1"
                        points="230.83 213.93 249.4 213.81 267.23 244.08 267.49 244.22 258.27 260.81 230.83 213.93" />
                    <polygon class="cls-2"
                        points="167.45 261.43 185.75 229.62 176.49 245.76 203.93 292.76 186.62 292.91 186.56 292.91 167.45 261.43" />
                    <polygon class="cls-1"
                        points="186.56 292.91 186.62 292.91 203.93 292.76 176.49 245.76 185.75 229.62 231.79 307.99 140.56 308.18 149.16 293.24 186.56 292.91" />
                </svg>
                <h1 class="logotype">DLUX</h1>
            </div>
            <!-- Add environment presets section -->
            <div class="panel-section">
                <h3>Environment</h3>
                <div style="margin-bottom: 15px; position: relative;">
                    <div style="position: relative; width: 100%;">
                        <select id="environment-preset"
                            style="width: 100%; background: #2c2c2c; color: #fff; border: 1px solid #3c3c3c; padding: 100px 8px 8px 8px; border-radius: 4px; appearance: none; text-align: left;">
                            <option value="none">None (Disable)</option>
                            <option value="default">Default</option>
                            <option value="contact">Contact</option>
                            <option value="forest">Forest</option>
                            <option value="egypt">Egypt</option>
                            <option value="checkerboard">Checkerboard</option>
                            <option value="goaland">Goaland</option>
                            <option value="yavapai">Yavapai</option>
                            <option value="goldmine">Goldmine</option>
                            <option value="threetowers">Three Towers</option>
                            <option value="poison">Poison</option>
                            <option value="arches">Arches</option>
                            <option value="tron">Tron</option>
                            <option value="japan">Japan</option>
                            <option value="dream">Dream</option>
                            <option value="volcano">Volcano</option>
                            <option value="starry">Starry</option>
                            <option value="osiris">Osiris</option>
                            <option value="moon">Moon</option>
                        </select>
                        <div id="environment-icon"
                            style="position: absolute; left: 0; top: 0; width: 100%; height: 92px; pointer-events: none; overflow: hidden; border-radius: 4px 4px 0 0;">
                            <img src="/playground/env_thumbs/none.png" alt="none environment"
                                style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <!-- Previous button -->
                        <div id="prev-environment"
                            style="position: absolute; left: 0; top: 0; width: 40px; height: 92px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: linear-gradient(to right, rgba(0,0,0,0.5), transparent);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15 6l-6 6 6 6" />
                            </svg>
                        </div>
                        <!-- Next button -->
                        <div id="next-environment"
                            style="position: absolute; right: 0; top: 0; width: 40px; height: 92px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: linear-gradient(to left, rgba(0,0,0,0.5), transparent);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 6l6 6-6 6" />
                            </svg>
                        </div>
                        <div style="position: absolute; right: 8px; bottom: 8px; pointer-events: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <script>
                    // Environment thumbnails mapping (to be populated with actual images)
                    const environmentThumbnails = {
                        none: '/playground/env_thumbs/none.png',
                        default: '/playground/env_thumbs/default.png',
                        contact: '/playground/env_thumbs/contact.png',
                        forest: '/playground/env_thumbs/forest.png',
                        egypt: '/playground/env_thumbs/egypt.png',
                        checkerboard: '/playground/env_thumbs/checkerboard.png',
                        goaland: '/playground/env_thumbs/goaland.png',
                        yavapai: '/playground/env_thumbs/yavapai.png',
                        goldmine: '/playground/env_thumbs/goldmine.png',
                        threetowers: '/playground/env_thumbs/threetowers.png',
                        poison: '/playground/env_thumbs/poison.png',
                        arches: '/playground/env_thumbs/arches.png',
                        tron: '/playground/env_thumbs/tron.png',
                        japan: '/playground/env_thumbs/japan.png',
                        dream: '/playground/env_thumbs/dream.png',
                        volcano: '/playground/env_thumbs/volcano.png',
                        starry: '/playground/env_thumbs/starry.png',
                        osiris: '/playground/env_thumbs/osiris.png',
                        moon: '/playground/env_thumbs/moon.png'
                    };

                    const select = document.getElementById('environment-preset');
                    const iconContainer = document.getElementById('environment-icon');

                    // Get ordered list of environments
                    const environments = Array.from(select.options).map(option => option.value);

                    // Update thumbnail when environment changes
                    function updateEnvironmentDisplay(value) {
                        const thumbnailPath = environmentThumbnails[value];
                        if (thumbnailPath) {
                            iconContainer.innerHTML = `<img src="${thumbnailPath}" alt="${value} environment" style="width: 100%; height: 100%; object-fit: cover;">`;
                        } else {
                            iconContainer.innerHTML = `<div style="width: 100%; height: 100%; background: #1c1c1c; display: flex; align-items: center; justify-content: center; color: #666;">Environment Preview</div>`;
                        }
                    }

                    // Handle environment changes
                    select.addEventListener('change', function (e) {
                        updateEnvironmentDisplay(e.target.value);
                    });

                    // Navigate to previous environment
                    document.getElementById('prev-environment').addEventListener('click', function (e) {
                        e.stopPropagation();
                        const currentIndex = environments.indexOf(select.value);
                        const prevIndex = (currentIndex - 1 + environments.length) % environments.length;
                        select.value = environments[prevIndex];
                        select.dispatchEvent(new Event('change'));
                    });

                    // Navigate to next environment
                    document.getElementById('next-environment').addEventListener('click', function (e) {
                        e.stopPropagation();
                        const currentIndex = environments.indexOf(select.value);
                        const nextIndex = (currentIndex + 1) % environments.length;
                        select.value = environments[nextIndex];
                        select.dispatchEvent(new Event('change'));
                    });
                </script>
                <div class="background-color-picker" style="margin-bottom: 15px;">
                    <label for="background-color" style="display: block; margin-bottom: 5px;">Background Color</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="color" id="background-color" value="#ECECEC"
                            style="width: 50px; height: 30px; padding: 0;">
                        <input type="text" id="background-color-hex" value="#ECECEC"
                            style="width: 80px; background: #2c2c2c; color: #fff; border: 1px solid #3c3c3c; padding: 5px;">
                    </div>
                </div>

            </div>
            <div class="fog-controls"
                style="margin-bottom: 15px; border: 1px solid #3c3c3c; border-radius: 4px; overflow: hidden;">
                <div class="collapsible-button"
                    style="background: #3c3c3c; padding: 8px 12px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s;"
                    onclick="toggleFogControls()" onmouseover="this.style.background='#4a4a4a'"
                    onmouseout="this.style.background='#3c3c3c'">
                    <h3 style="margin: 0; padding: 0; color: #fff; font-size: 16px;">Fog</h3>
                    <span id="fog-collapse-icon"
                        style="font-size: 12px; transition: transform 0.3s; transform: rotate(0deg); color: #fff;">â–¼</span>
                </div>
                <div id="fog-collapse-content"
                    style="overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0px; background: #2c2c2c; border-top: 1px solid #3c3c3c;">
                    <div style="padding: 10px;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px;">Fog Color</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" id="fog-color" value="#ffffff"
                                    style="width: 50px; height: 30px; padding: 0;">
                                <input type="text" id="fog-color-hex" value="#ECECEC"
                                    style="width: 80px; background: #2c2c2c; color: #fff; border: 1px solid #3c3c3c; padding: 5px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px;">Fog Type</label>
                            <div
                                style="display: flex; gap: 10px; align-items: center; background: #2c2c2c; padding: 5px; border-radius: 4px; border: 1px solid #3c3c3c;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="fog-type" value="linear" style="margin: 0;">
                                    <span style="color: #fff;">Linear</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="fog-type" value="exponential" checked style="margin: 0;">
                                    <span style="color: #fff;">Exponential</span>
                                </label>
                            </div>
                        </div>
                        <div id="fog-linear-controls" style="margin-bottom: 10px; display: none;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px;">Near Distance</label>
                                <input type="range" id="fog-near" min="0" max="100" step="0.1" value="1"
                                    style="width: 100%;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px;">Far Distance</label>
                                <input type="range" id="fog-far" min="0" max="250" step="0.1" value="50"
                                    style="width: 100%;">
                            </div>
                        </div>
                        <div id="fog-exponential-controls" style="margin-bottom: 10px; display: block;">
                            <label style="display: block; margin-bottom: 5px;">Density</label>
                            <input type="range" id="fog-intensity" min="0" max="1" step="0.01" value="0.25"
                                style="width: 100%;">
                        </div>
                        <button id="toggle-fog-btn" onclick="toggleFog()" class="effect-btn" style="width: 100%;">
                            <span>Add Fog</span>
                        </button>
                    </div>
                </div>
            </div>
            <h3>Assets</h3>
            <div style="margin-bottom: 15px;">
                <input type="file" id="asset-upload" accept="image/*,video/*,.gltf,.glb" onchange="handleFileUpload()"
                    style="display: none;">
                <button onclick="document.getElementById('asset-upload').click()" class="effect-btn"
                    style="width: 100%;">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,4L12,20" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        <path d="M4,12L20,12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    <span>Add File</span>
                </button>
            </div>
            <div id="asset-library"></div>
            <h3>Add Objects</h3>
            <div class="geometry-buttons">
                <!-- Basic Shapes -->
                <button onclick="addEntity('box')">
                    <svg viewBox="0 0 24 24">
                        <rect x="4" y="4" width="16" height="16" class="filled" />
                    </svg>
                    Box
                </button>
                <button onclick="addEntity('sphere')">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="8" class="filled" />
                        <ellipse cx="12" cy="12" rx="8" ry="3" />
                        <line x1="4" y1="12" x2="20" y2="12" />
                    </svg>
                    Sphere
                </button>
                <button onclick="addEntity('cylinder')">
                    <svg viewBox="0 0 24 24">
                        <path d="M6 7 C6 7 6 17 6 17 C6 19 12 19 12 17 C12 17 12 7 12 7 C12 5 6 5 6 7" class="filled" />
                        <ellipse cx="9" cy="7" rx="3" ry="1" />
                        <ellipse cx="9" cy="17" rx="3" ry="1" />
                    </svg>
                    Cylinder
                </button>
                <button onclick="addEntity('plane')">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 12 L12 6 L20 12 L12 18 Z" class="filled" />
                    </svg>
                    Plane
                </button>
                <button onclick="addEntity('cone')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 4 L4 20 L20 20 Z" class="filled" />
                    </svg>
                    Cone
                </button>
                <button onclick="addEntity('torus')">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="8" class="filled" />
                        <circle cx="12" cy="12" r="4" />
                    </svg>
                    Torus
                </button>
                <button onclick="addEntity('ring')">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="8" />
                        <circle cx="12" cy="12" r="4" />
                    </svg>
                    Ring
                </button>
                <button onclick="addEntity('circle')">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="8" />
                    </svg>
                    Circle
                </button>
                <button onclick="addEntity('dodecahedron')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 4 L18 8 L18 16 L12 20 L6 16 L6 8 Z" class="filled" />
                        <line x1="12" y1="4" x2="12" y2="20" />
                        <line x1="6" y1="8" x2="18" y2="8" />
                        <line x1="6" y1="16" x2="18" y2="16" />
                    </svg>
                    Dodecahedron
                </button>
                <button onclick="addEntity('octahedron')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 4 L20 12 L12 20 L4 12 Z" class="filled" />
                    </svg>
                    Octahedron
                </button>
                <button onclick="addEntity('tetrahedron')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 4 L18 18 L6 18 Z" class="filled" />
                        <line x1="6" y1="18" x2="18" y2="18" />
                    </svg>
                    Tetrahedron
                </button>
                <button onclick="addEntity('triangle')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 4 L20 18 L4 18 Z" />
                    </svg>
                    Triangle
                </button>
                <button onclick="addEntity('torusKnot')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 8 C16 8 16 16 12 16 C8 16 8 8 12 8" class="filled" />
                        <path d="M8 12 C8 8 16 8 16 12 C16 16 8 16 8 12" />
                    </svg>
                    Torus Knot
                </button>
                <button onclick="addEntity('ocean')">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 14 Q8 10 12 14 Q16 18 20 14" class="filled" />
                        <path d="M4 18 Q8 14 12 18 Q16 22 20 18" />
                    </svg>
                    Ocean
                </button>
                <button onclick="addEntity('tube')">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 12 C8 6 16 18 20 12" class="filled" />
                    </svg>
                    Tube
                </button>
                <button onclick="addEntity('grid')">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 4 L20 4 L20 20 L4 20 Z" />
                        <line x1="9" y1="4" x2="9" y2="20" />
                        <line x1="15" y1="4" x2="15" y2="20" />
                        <line x1="4" y1="9" x2="20" y2="9" />
                        <line x1="4" y1="15" x2="20" y2="15" />
                    </svg>
                    Grid
                </button>
            </div>

            <h3>Particle Effects</h3>
            <div class="particle-buttons"
                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 15px;">
                <button id="snow-btn" onclick="toggleParticleSystem('snow')" class="effect-btn">
                    <svg viewBox="0 0 24 24">
                        <circle cx="6" cy="6" r="1" />
                        <circle cx="10" cy="12" r="1" />
                        <circle cx="15" cy="6" r="1" />
                        <circle cx="19" cy="12" r="1" />
                        <circle cx="8" cy="18" r="1" />
                        <circle cx="16" cy="18" r="1" />
                        <circle cx="12" cy="4" r="1" />
                        <circle cx="4" cy="12" r="1" />
                        <circle cx="20" cy="4" r="1" />
                    </svg>
                    Snow
                </button>
                <button id="dust-btn" onclick="toggleParticleSystem('dust')" class="effect-btn">
                    <svg viewBox="0 0 24 24">
                        <circle cx="6" cy="6" r="1" />
                        <circle cx="10" cy="12" r="1" />
                        <circle cx="15" cy="6" r="1" />
                        <circle cx="19" cy="12" r="1" />
                        <circle cx="8" cy="18" r="1" />
                        <circle cx="16" cy="18" r="1" />
                        <circle cx="12" cy="4" r="1" />
                        <circle cx="4" cy="12" r="1" />
                        <circle cx="20" cy="4" r="1" />
                    </svg>
                    Dust
                </button>
                <button id="rain-btn" onclick="toggleParticleSystem('rain')" class="effect-btn">
                    <svg viewBox="0 0 24 24">
                        <!-- Simplified rain drops icon - just vertical lines -->
                        <path d="M6,8L6,20" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        <path d="M10,4L10,18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        <path d="M14,6L14,19" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        <path d="M18,5L18,16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Rain
                </button>
                <button id="toggle-animation-btn" onclick="toggleParticleAnimation()" class="effect-btn" disabled>
                    <svg viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" id="animation-icon" />
                    </svg>
                    <span id="animation-text">Start</span>
                </button>
            </div>
            
            <!-- Commenting out skybox uploader - to be replaced
            <div class="panel-section">
                <h3>Skybox</h3>

                <div id="skybox-container" class="asset-grid" style="margin-bottom: 10px;">
                    
                </div>
                <div style="margin-bottom: 15px;">
                  
                    <input type="file" id="skybox-input" accept="image/*,video/*" style="display: none;">
                    <button onclick="document.getElementById('skybox-input').click()" class="effect-btn"
                        style="width: 100%;">
                        <svg viewBox="0 0 24 24">
                            <path d="M12,4L12,20" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            <path d="M4,12L20,12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        Upload Skybox
                    </button>
                   
                </div>
            </div> -->
        </div>

        <div class="main-content">
            <div class="toolbar" id="view-selector">
                <button onclick="switchToView('code')">Edit Code</button>
                <button onclick="switchToView('scene')">Preview Scene</button>
                <button onclick="switchToView('inspector')">Inspector</button>
                <button onclick="saveScene()">Save Scene</button>
                <button onclick="resetScene()">Reset Scene</button>
                <button onclick="clearScene()">Clear Scene</button>
                <button onclick="clearEntities()">Clear Entities</button>
            </div>

            <div class="scene-container">
                <a-scene embedded id="scene" background="color: #ECECEC">
                    <a-assets id="asset-container">
                        <!-- Uploaded assets will be added here -->
                    </a-assets>

                    <!-- Default scene setup -->
                    <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
                    <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
                    <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
                    <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
                    <a-camera position="0 1.6 0"></a-camera>
                </a-scene>
                <div id="code-panel"></div>
            </div>
        </div>
    </div>

    <div class="sync-to-code-panel-container hidden">
        <span class="sync-to-code-panel-status">Sync to Code Panel</span>
    </div>

    <script>
        // Global variables
        let currentView = 'scene';
        let scene = document.querySelector('a-scene');
        const codePanel = document.querySelector('#code-panel');
        let editor;
        let fogActive = false; // Initialize fog state

        // Load Monaco editor after A-Frame is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load Monaco editor
            require(['vs/editor/editor.main'], function() {
                // Define HTML language configuration for A-Frame
                monaco.languages.html.htmlDefaults.options.format.indentInnerHtml = true;
                monaco.languages.html.htmlDefaults.options.format.wrapLineLength = 0;
                
                // Initialize Monaco editor
                editor = monaco.editor.create(codePanel, {
                    language: 'html',
                    theme: 'vs-dark',
            lineNumbers: true,
                    automaticLayout: true,
                    wordWrap: 'on',
                    minimap: { enabled: false },
                    tabSize: 4,
                    value: ''
                });
                
                // Register A-Frame language support
                registerAFrameCompletions();
                
                // Initial update of the code panel
                    updateCodePanel();
            });
        });
        
        // A-Frame language support for Monaco
        function registerAFrameCompletions() {
            // Define A-Frame tag completions
            const aframeTagCompletions = [
                { label: 'a-scene', documentation: 'Root element of every A-Frame experience' },
                { label: 'a-entity', documentation: 'General-purpose entity in A-Frame scene' },
                { label: 'a-box', documentation: 'Cube/box primitive' },
                { label: 'a-sphere', documentation: 'Sphere primitive' },
                { label: 'a-cylinder', documentation: 'Cylinder primitive' },
                { label: 'a-plane', documentation: 'Flat plane primitive' },
                { label: 'a-sky', documentation: 'Background sphere/skybox' },
                { label: 'a-camera', documentation: 'Camera entity' },
                { label: 'a-light', documentation: 'Light source' },
                { label: 'a-assets', documentation: 'Asset management system' }
            ];
            
            // Define A-Frame component completions
            const aframeComponentCompletions = [
                { label: 'position', documentation: 'Position in 3D space (x y z)' },
                { label: 'rotation', documentation: 'Rotation in degrees (x y z)' },
                { label: 'scale', documentation: 'Scale (x y z)' },
                { label: 'material', documentation: 'Material properties' },
                { label: 'light', documentation: 'Light properties' },
                { label: 'geometry', documentation: 'Geometry properties' },
                { label: 'environment', documentation: 'Environment component settings' }
            ];
            
            // Register custom HTML completions
            monaco.languages.registerCompletionItemProvider('html', {
                provideCompletionItems: function(model, position) {
                    const textUntilPosition = model.getValueInRange({
                        startLineNumber: position.lineNumber,
                        startColumn: 1,
                        endLineNumber: position.lineNumber,
                        endColumn: position.column
                    });
                    
                    // Check for tag completion context
                    if (textUntilPosition.match(/<[a-zA-Z-]*$/)) {
                        return {
                            suggestions: aframeTagCompletions.map(item => ({
                                label: item.label,
                                kind: monaco.languages.CompletionItemKind.Class,
                                documentation: item.documentation,
                                insertText: item.label,
                                range: {
                                    startLineNumber: position.lineNumber,
                                    startColumn: textUntilPosition.lastIndexOf('<') + 1,
                                    endLineNumber: position.lineNumber,
                                    endColumn: position.column
                                }
                            }))
                        };
                    }
                    
                    // Check for attribute completion context
                    if (textUntilPosition.match(/<a-[a-zA-Z-]+ [^>]*$/)) {
                        return {
                            suggestions: aframeComponentCompletions.map(item => ({
                                label: item.label,
                                kind: monaco.languages.CompletionItemKind.Property,
                                documentation: item.documentation,
                                insertText: `${item.label}=""`,
                                range: {
                                    startLineNumber: position.lineNumber,
                                    startColumn: position.column,
                                    endLineNumber: position.lineNumber,
                                    endColumn: position.column
                                }
                            }))
                        };
                    }
                    
                    return { suggestions: [] };
                }
            });
        }

        function updateCodePanel() {
            if (!editor) return; // Don't proceed if editor isn't initialized
            
            fixDefaultLightDuplication();
            const sceneClone = scene.cloneNode(true);
            cleanupSceneElement(sceneClone);

            // Start with the scene tag and its attributes
            let content = '';

            content += '<a-scene';
            if (scene.hasAttribute('embedded')) content += ' embedded';

            // Always include background color if present
            if (scene.hasAttribute('background')) {
                const background = scene.getAttribute('background');
                // Format the background attribute properly
                if (typeof background === 'string') {
                    // New format (string)
                    // Extract color and ensure it's uppercase
                    const match = background.match(/color:\s*(#[0-9A-Fa-f]{6})/i);
                    if (match) {
                        const color = match[1].toUpperCase();
                        content += ` background="color: ${color}"`;
                    } else {
                        content += ` background="${background}"`;
                    }
                } else {
                    // Old format (object)
                    const color = background.color || '#ECECEC';
                    content += ` background="color: ${color.toUpperCase()}"`;
                }
            }

            // Add fog if active
            if (fogActive && scene.hasAttribute('fog')) {
                const fogColor = document.getElementById('fog-color').value.toUpperCase();
                const fogType = document.querySelector('input[name="fog-type"]:checked').value;
                let fogString;
                if (fogType === 'linear') {
                    const fogNear = document.getElementById('fog-near').value;
                    const fogFar = document.getElementById('fog-far').value;
                    fogString = `type: linear; color: ${fogColor}; near: ${fogNear}; far: ${fogFar}`;
                } else {
                    const fogIntensity = document.getElementById('fog-intensity').value;
                    fogString = `type: exponential; color: ${fogColor}; density: ${fogIntensity}`;
                }
                content += ` fog="${fogString}"`;
            }
            content += '>\n';

            // Add all the scene content
            content += formatSceneContent(sceneClone);

            // Close the scene tag
            content += '</a-scene>';

            // Update the editor (Monaco version)
            if (editor && editor.getModel) {
                editor.getModel().setValue(content);
            }
        }
        
        function updateSceneFromCode(code) {
            // If no code is provided, get it from the editor
            if (!code && editor) {
                if (editor.getModel) {
                    // Monaco API
                    code = editor.getModel().getValue();
                }
            }
            
            // Create a temporary container
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = code;

            // Get the scene element from the temporary container
            const newScene = tempContainer.querySelector('a-scene');
            if (!newScene) {
                console.error('No scene element found in code, changes made to the code aren\'t saved to the dom');
                return;
            }

            // Create a new scene with the same configuration
            const scene = document.createElement('a-scene');
            scene.setAttribute('embedded', '');
            scene.setAttribute('renderer', 'antialias: true; colorManagement: true; physicallyCorrectLights: true; sortObjects: true;');

            // Set scene attributes from the new scene
            const sceneAttributes = newScene.attributes;
            for (let i = 0; i < sceneAttributes.length; i++) {
                const attr = sceneAttributes[i];
                if (attr.name !== 'embedded') { // Skip embedded as we set it above
                    scene.setAttribute(attr.name, attr.value);
                }
            }

            // Transfer all children from the new scene to our scene
            Array.from(newScene.children).forEach(child => {
                scene.appendChild(child.cloneNode(true));
            });

            // Replace the old scene with the new one
            const oldScene = document.querySelector('a-scene');
            oldScene.parentNode.replaceChild(scene, oldScene);

                    // Update the scene reference
            window.scene = scene;

            // Wait for the scene to initialize
                    setTimeout(() => {
                // Check for environment
                const environment = scene.querySelector('a-entity[environment]');
                if (!environment) {
                    // If no environment, add default ambient and directional lights
                        const ambientLight = document.createElement('a-entity');
                    ambientLight.setAttribute('light', 'color: #BBB; type: ambient');
                        scene.appendChild(ambientLight);

                        const directionalLight = document.createElement('a-entity');
                    directionalLight.setAttribute('light', 'color: #FFF; intensity: 1.884; castShadow: true');
                        directionalLight.setAttribute('position', '-0.5 1 1');
                        scene.appendChild(directionalLight);

                    // Add default sky with gradient - only if no sky already exists
                    if (!scene.querySelector('a-sky')) {
                        const sky = document.createElement('a-sky');
                        sky.setAttribute('class', 'environment');
                        sky.setAttribute('material', 'shader: gradientshader; topColor: #ECECEC; bottomColor: #87CEEB');
                        scene.appendChild(sky);
                    }
                }

                // Force a render
                    if (scene.renderer) {
                        scene.renderer.render(scene.object3D, scene.camera);
                }

                // Check for environments or custom skybox
                const hasEnvironment = scene.querySelector('a-entity[environment]');
                const hasCustomSkybox = scene.querySelector('a-sky[src]');
                if (hasEnvironment || hasCustomSkybox) {
                    const skyColorPicker = document.getElementById('sky-color');
                    if (skyColorPicker) {
            skyColorPicker.disabled = false;
                    }
                }
                }, 100);
        }
        
        function switchToView(view) {
            const previousView = currentView;
            currentView = view;
            
            // Get references to UI elements
            const sceneBtn = document.getElementById('scene-btn');
            const codeBtn = document.getElementById('code-btn');
            const sceneContainer = document.querySelector('#scene');
            
            if (view === 'scene') {
                // Update scene from code if coming from code view
                if (previousView === 'code') {
                    updateSceneFromCode();
                }
                
                // Show scene, hide code panel
                sceneContainer.style.display = 'block';
                codePanel.style.display = 'none';
                
                // Update button states
                sceneBtn.classList.add('active');
                codeBtn.classList.remove('active');
                
                // Clean up inspector if open
                cleanupInspector();
            } else if (view === 'code') {
                // Hide scene, show code panel
                sceneContainer.style.display = 'none';
                codePanel.style.display = 'block';
                
                // Update button states
                sceneBtn.classList.remove('active');
                codeBtn.classList.add('active');
                
                // Update code panel with current scene
            updateCodePanel();
                
                // Clean up inspector if open
                cleanupInspector();
                
                // Focus the editor
                if (editor) {
                    setTimeout(() => {
                        editor.focus();
                    }, 100);
                }
            }
        }

        function cleanupInspector() {
            if (AFRAME && AFRAME.INSPECTOR && AFRAME.INSPECTOR.opened) {
                AFRAME.INSPECTOR.close();
            }
        }
        
        // Add other functions from your original code here...
    </script>
</body>

</html>
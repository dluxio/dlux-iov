<!doctype html>
<html lang="en" class="h-100">

<head>
    <title>New DLUX Post</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" href="/img/dlux-icon-192.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DLUX">
    <meta name="theme-color" content="#111222" />
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <script src="/js/cryptojs.min.js"></script>
    <!-- Bootstrap -->
    <link href="/css/custom.css" rel="stylesheet" />
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Space+Grotesk:wght@300..700&display=swap"
        rel="stylesheet">
    <script src="https://kit.fontawesome.com/0f693ffc58.js" crossorigin="anonymous"></script>
    <!-- Markdown -->
    <script src="https://unpkg.com/showdown@1.x/dist/showdown.min.js"></script>
    <link rel="stylesheet"
        href="https://cdn.rawgit.com/CoffeePerry/simplemde-theme-bootstrap-dark/master/dist/simplemde-theme-bootstrap-dark.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <!-- Marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/js/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked-linkify-it/lib/index.umd.js"></script>
    <!-- Tagify -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/hive-tx/dist/hive-tx.min.js"></script>
    <!-- Upload Scripts -->
    <script type="text/javascript" src="/js/onlyhash.js"></script>
    <script src="/js/buffer.js"></script>
    <script src="/js/drag-drop.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <!-- Tiptap Editor Styles -->
    <link href="/css/tiptap-editor.css" rel="stylesheet" />
    <script src="/reg-sw.js"></script>
    <script src="/js/diff.js"></script>
    <script>
        var video_page = true
        marked.use(markedLinkifyIt({
            '@': {
                validate: function (text, pos, self) {
                    var tail = text.slice(pos);

                    if (!self.re.hive) {
                        self.re.hive = new RegExp(
                            '^([a-z0-9\.\-]){1,16}(?!_)(?=$|' + self.re.src_ZPCc + ')'
                        );
                    }
                    if (self.re.hive.test(tail)) {
                        if (pos >= 2 && tail[pos - 2] === '@') {
                            return false;
                        }
                        return tail.match(self.re.hive)[0].length;
                    }
                    return 0;
                },
                normalize: function (match) {
                    if (match.url.endsWith('.')) {
                        match.url = match.url.substring(0, match.url.length - 1);
                    }
                    match.url = '/@' + match.url.replace(/^@/, '');
                }
            }
        }, {}));
    </script>
    <!-- FFmpeg WASM - Local files to avoid CORS issues -->
    <script src="/packages/ffmpeg/package/dist/umd/ffmpeg.js"></script>
    <script src="/packages/util/package/dist/umd/index.js"></script>
    <script src="https://unpkg.com/rxjs@^7/dist/bundles/rxjs.umd.min.js"></script>
    <script src="https://github.com/videojs/mux.js/releases/latest/download/mux.js"></script>
    <!-- HLS.js for M3U8 video playback support in Chrome/Firefox -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Vue Controller -->
    <script type="module" src="/js/v3-user.js"></script>
    <style>
        .form-switch.form-switch-lg .form-check-input {
            height: 2rem;
            width: calc(3rem + 0.75rem);
            border-radius: 4rem;
        }

        .accordion {
            --bs-accordion-color: rgb(173, 181, 189);
            --bs-accordion-bg: #212529;
            --bs-accordion-border-color: #495057;
            --bs-accordion-btn-color: #5C94FE;
            --bs-accordion-btn-bg: #2f3133;
            --bs-accordion-btn-icon: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%235C94FE'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
            --bs-accordion-btn-active-icon: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%235C94FE'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
            --bs-accordion-active-color: #5C94FE;
            --bs-accordion-active-bg: #001D4C;

        }

        .selected-div {
            background: #434851;
            border: 0;
        }

        .hover-div:hover {
            background: #434851;
        }

        .v-enter-active,
        .v-leave-active {
            transition: opacity .0s ease;
        }

        .scroll {
            padding-top: 70px;
            padding-bottom: 20px;
        }

        @media (min-width: 1200px) {
            .scroll {
                overflow-y: scroll;
                height: 100%;

            }
        }

        iframe {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        iframe img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .v-enter-from,
        .v-leave-to {
            opacity: 0;
        }

        [data-bs-toggle="collapse"].collapsed .if-not-collapsed {
            display: none;
        }

        [data-bs-toggle="collapse"]:not(.collapsed) .if-collapsed {
            display: none;
        }

        #img-well {
            border-style: dashed;
            border-radius: 10px;
            border-width: 5px;
            border-color: rgba(255, 255, 255, 0.5);
        }

        #img-well.drag {
            background: #8ED2C9;
        }

        .overlay {
            z-index: 1;
            background-color: transparent;
        }

        .frame-360 {
            position: relative;
            z-index: 0;
        }
    </style>
</head>

<body>
    <div id="app" class="d-flex flex-column vh-100" v-cloak>
        <!-- navbar -->
        <div>
            <nav-vue @login="account = $event;newme($event)" @logout="account = '';removeUser()" @ack="removeOp($event)"
                @refresh="run($event)" :op="toSign" :lapi="lapi" />
        </div>
        <main role="main" class="d-flex flex-column flex-grow-1 padmain-subbar">

            <div class="container fixed-top navbar-subbar p-0">
                <div class="navbar-subbar-container">
                    <div class="navbar-subbar-content">
                        <!-- Post Type Selection -->
                        <div class="d-flex justify-content-center me-auto btn-group">
                            <!-- Blog Post -->
                            <button class="btn btn-sm btn-outline-primary px-2" :class="{active: postCustom_json.vrHash == 'blog'}"
                                @click="postCustom_json.vrHash = 'blog';types='img,vid'">
                                <i class="fa-solid fa-book fa-fw me-2"></i>Blog Post
                            </button>
                            <!-- Video -->
                            <button class="btn btn-sm btn-outline-primary px-2" :class="{active: postCustom_json.vrHash == 'video'}"
                                @click="postCustom_json.vrHash = 'video';types='img,vid'">
                                <i class="fa-solid fa-film fa-fw me-2"></i>Video
                            </button>
                            <!-- 360 Image Gallery -->
                            <button class="btn btn-sm btn-outline-primary px-2"
                                :class="{active: postCustom_json.vrHash == 'QmcAkxXzczkzUJWrkWNhkJP9FF1L9Lu5sVCrUFtAZvem3k'}"
                                @click="postCustom_json.vrHash = 'QmcAkxXzczkzUJWrkWNhkJP9FF1L9Lu5sVCrUFtAZvem3k';types='ts,img'">
                                <i class="fa-solid fa-globe fa-fw me-2"></i>360 Image Gallery
                            </button>
                            <!-- New dApp -->
                            <button class="btn btn-sm btn-outline-primary px-2" :class="{active: postCustom_json.vrHash == 'dapp'}"
                                @click="postCustom_json.vrHash = 'dapp';types='ts,obj,img,vid,aud,app,pdf,oth,bin,doc,txt'">
                                <i class="fa-solid fa-mobile-screen-button fa-fw me-2"></i>New dApp
                            </button>
                            <!-- ReMix dApp -->
                            <button class="btn btn-sm btn-outline-primary px-2" :class="{active: postCustom_json.vrHash == 'remix'}"
                                @click="postCustom_json.vrHash = 'remix';types='ts,obj,img,vid,aud,app,pdf,oth,bin,doc,txt'">
                                <i class="fa-solid fa-shuffle fa-fw me-2"></i>ReMix dApp
                            </button>
                        </div>
                        <!-- blog buttons -->
                        <div class="d-flex justify-content-center ms-auto">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-secondary px-2"
                                    @click="saveNewToken()"><i class="fa-solid fa-fw fa-floppy-disk me-2"
                                        aria-hidden="true"></i>Save</button>
                                <button type="button" class="btn btn-sm btn-dark  ms-0 me-0 ps-0 pe-0 disabled"></button>

                                <button type="button"
                                    class="btn btn-sm btn-secondary dropdown-toggle px-2"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-solid fa-fw fa-folder-open me-2"></i>Open
                                </button>
                                <ul class="dropdown-menu bg-black dropdown-menu-dark">
                                    <li>
                                        <h6 class="dropdown-header">LOCAL STORAGE</h6>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider mt-0 mb-1">
                                    </li>
                                    <li class="text-center lead mb-2" v-if="!pendingTokens.length">Empty</li>
                                    <li class="d-flex align-items-center justify-content-between"
                                        v-for="pend of pendingTokens">
                                        <a @click="loadNewToken(pend)" class="mx-1 dropdown-item rounded"
                                            role="button">{{pend}}</a>
                                        <a @click="deleteNewToken(pend)" class="mx-1 btn btn-sm btn-outline-danger"
                                            role="button"><i class="fa-solid fa-trash-can fa-fw"></i></a>
                                    </li>
                                </ul>


                                <button type="button" class="btn btn-sm btn-secondary d-none rounded-pill px-2 ms-1"
                                    @click="saveNewToken()"><i class="fa-solid fa-fw fa-flag-checkered me-2"
                                        aria-hidden="true"></i>Publish</button>


                            </div>
                        </div>
                        <!-- 360 toggle buttons -->
                        <div class="d-flex justify-content-center ms-auto"
                            v-if="postCustom_json.vrHash == 'QmcAkxXzczkzUJWrkWNhkJP9FF1L9Lu5sVCrUFtAZvem3k'">
                            <!-- assets button -->
                            <a class="ms-1 no-decoration" data-bs-toggle="collapse" href="#assetMgr">
                                <span class="if-collapsed">
                                    <button class="btn btn-outline-light d-flex align-items-center">
                                        <i class="fa-solid fa-shapes fa-fw force-parent-lh"></i>
                                        <span class="d-none d-md-block ms-1">Assets</span>
                                    </button>
                                </span>
                                <span class="if-not-collapsed">
                                    <button class="btn btn-light d-flex align-items-center">
                                        <i class="fa-solid fa-shapes fa-fw force-parent-lh"></i><span
                                            class="d-none d-md-block ms-1">Assets</span>
                                    </button>
                                </span>
                            </a>
                            <!-- dapp button -->
                            <a class="ms-1 collapsed no-decoration" data-bs-toggle="collapse" href="#dappPreview">
                                <span class="if-collapsed">
                                    <button class="btn btn-outline-light d-flex align-items-center">
                                        <i class="fa-solid fa-up-down-left-right fa-fw force-parent-lh"></i><span
                                            class="d-none d-md-block ms-1">Preview</span>
                                    </button>
                                </span>
                                <span class="if-not-collapsed">
                                    <button class="btn btn-light d-flex align-items-center">
                                        <i class="fa-solid fa-up-down-left-right fa-fw force-parent-lh"></i><span
                                            class="d-none d-md-block ms-1">Preview</span>
                                    </button>
                                </span>
                            </a>
                            <!-- post button -->
                            <a class="ms-1 collapsed no-decoration" data-bs-toggle="collapse" href="#editPost">
                                <span class="if-collapsed">
                                    <button class="btn btn-outline-light d-flex align-items-center">
                                        <i class="fa-solid fa-pen-to-square fa-fw force-parent-lh"></i><span
                                            class="d-none d-md-block ms-1">Description</span>
                                    </button>
                                </span>
                                <span class="if-not-collapsed">
                                    <button class="btn btn-light d-flex align-items-center">
                                        <i class="fa-solid fa-pen-to-square fa-fw force-parent-lh"></i><span
                                            class="d-none d-md-block ms-1">Description</span>
                                    </button>
                                </span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ALT CHOICE Post Type Selection -->
            <div class="container d-none">
                <div class="accordion border-white-50 rounded mt-3" id="postTypeAccordion">
                    <div class="accordion-item bg-img-none bg-dark-1">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#postTypeCollapse" aria-expanded="true"
                                aria-controls="postTypeCollapse">
                                <i class="fa-solid fa-list fa-fw me-2"></i>Post Type Selection
                            </button>
                        </h2>
                        <div id="postTypeCollapse" class="accordion-collapse collapse show"
                            data-bs-parent="#postTypeAccordion">
                            <div class="accordion-body">
                                <div class="d-flex flex-wrap justify-content-center gap-2">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Container -->
            <div class="container">

                <!-- User Registration Section -->
                <div v-if="spkapi.pubKey == 'NA'" class="alert alert-warning d-flex align-items-center mt-3"
                    role="alert">
                    <i class="fa-solid fa-user-gear fa-fw me-2"></i>
                    <div class="flex-grow-1">
                        <strong>Welcome!</strong> Register your account to store files on SPK Network.
                    </div>
                    <button type="button" class="btn btn-primary btn-sm ms-2" @click="updatePubkey()">
                        <i class="fa-solid fa-user-plus fa-fw me-1"></i> Register Account
                    </button>
                </div>

                <!-- Video Transcoding Section (Only show for video posts) -->
                <div v-if="postCustom_json.vrHash == 'video' && spkapi.pubKey != 'NA'"
                    class="accordion border-white-50 rounded mt-3" id="videoAccordion">
                    <div class="accordion-item bg-img-none bg-dark-1">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#videoTranscode" aria-expanded="true" aria-controls="videoTranscode">
                                <i class="fa-solid fa-film fa-fw me-2"></i>Video Transcoding & Upload
                            </button>
                        </h2>
                        <div id="videoTranscode" class="accordion-collapse collapse show"
                            data-bs-parent="#videoAccordion">
                            <div class="accordion-body">
                                <!-- FFmpeg Status -->
                                <div v-if="!ffmpegReady && !ffmpegSkipped"
                                    class="alert alert-info d-flex align-items-center mb-3" role="alert">
                                    <i class="fa-solid fa-gears fa-fw me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>FFmpeg Required:</strong> Video transcoding needs FFmpeg to be loaded.
                                        <div v-if="videoMsg.includes('Loading') || videoMsg.includes('Downloading') || videoMsg.includes('Preparing')"
                                            class="small mt-1">
                                            {{videoMsg}}
                                            <!-- FFmpeg Download Progress Bar -->
                                            <div v-if="ffmpegDownloadProgress > 0" class="mt-2">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                        role="progressbar" :style="`width: ${ffmpegDownloadProgress}%`"
                                                        :aria-valuenow="ffmpegDownloadProgress" aria-valuemin="0"
                                                        aria-valuemax="100">
                                                    </div>
                                                </div>
                                                <div class="text-center mt-1 small text-muted">
                                                    {{ffmpegDownloadProgress}}% - FFmpeg WASM Core (~31MB)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm ms-2" @click="downloadFFmpeg()"
                                        :disabled="videoMsg.includes('Loading') || videoMsg.includes('Downloading') || videoMsg.includes('Preparing')">
                                        <i class="fa-solid fa-download fa-fw me-1"></i>
                                        <span
                                            v-if="videoMsg.includes('Loading') || videoMsg.includes('Downloading') || videoMsg.includes('Preparing')">Loading...</span>
                                        <span v-else>Load FFmpeg</span>
                                    </button>
                                    <button class="btn btn-secondary btn-sm ms-1" @click="skipFFmpeg()"
                                        :disabled="videoMsg.includes('Loading') || videoMsg.includes('Downloading') || videoMsg.includes('Preparing')">
                                        <i class="fa-solid fa-arrow-right fa-fw me-1"></i>Skip
                                    </button>
                                </div>

                                <!-- FFmpeg Error/Alternative -->
                                <div v-if="ffmpegSkipped" class="alert alert-info d-flex align-items-center mb-3"
                                    role="alert">
                                    <i class="fa-solid fa-info-circle fa-fw me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>Direct Upload Mode:</strong> FFmpeg transcoding is not available. You
                                        can upload pre-processed video files directly.
                                        <div class="small mt-1">
                                            Supported formats: MP4, WebM, AVI, MOV, and most common video formats.
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm ms-2"
                                        @click="ffmpegSkipped = false; ffmpegReady = false; downloadFFmpeg()">
                                        <i class="fa-solid fa-refresh fa-fw me-1"></i>Try FFmpeg Again
                                    </button>
                                </div>

                                <!-- Video Upload Interface -->
                                <div v-if="ffmpegReady || ffmpegSkipped">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6><i class="fa-solid fa-video fa-fw me-1"></i>Transcode a Video</h6>
                                            <p class="small text-muted mb-2">
                                                Transcoding creates multiple quality versions of your video, giving
                                                users the best
                                                experience based on their bandwidth while enabling seamless seeking and
                                                smooth playback.
                                            </p>
                                            <input type="file" @change="transcode" accept="video/*"
                                                class="form-control mb-2">
                                            <small class="text-muted">Select a video file to transcode into multiple
                                                resolutions</small>
                                        </div>
                                        <div class="col-md-6" v-if="videosrc">
                                            <h6><i class="fa-solid fa-play fa-fw me-1"></i>Preview</h6>
                                            <video :src="videosrc" controls class="w-100"
                                                style="max-height: 200px;"></video>
                                        </div>
                                    </div>

                                    <!-- Status Message with Progress Bar -->
                                    <div v-if="videoMsg && videoMsg !== 'Drop a video file to transcode'" class="mt-2">
                                        <div class="alert alert-info">
                                            <i class="fa-solid fa-info-circle fa-fw me-1"></i>{{videoMsg}}

                                            <!-- Progress Bar for Transcoding -->
                                            <div v-if="videoMsg.includes('Transcoding:') && videoMsg.includes('%')"
                                                class="mt-2">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                        role="progressbar"
                                                        :style="`width: ${extractProgressPercent(videoMsg)}%`"
                                                        :aria-valuenow="extractProgressPercent(videoMsg)"
                                                        aria-valuemin="0" aria-valuemax="100">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Progress Bar for Hashing -->
                                            <div v-if="videoMsg.includes('Hashing') && hashingProgress.total > 0"
                                                class="mt-2">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                                        role="progressbar"
                                                        :style="`width: ${hashingProgress.percentage}%`"
                                                        :aria-valuenow="hashingProgress.percentage" aria-valuemin="0"
                                                        aria-valuemax="100">
                                                    </div>
                                                </div>
                                                <small class="text-muted">{{hashingProgress.currentFile}}</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Upload Everywhere Component for Video Files -->
                                    <div class="alert alert-info bg-dark-1 border-info">
                                        <h6 class="mb-1">
                                            <i class="fa-solid fa-upload fa-fw me-1"></i>Upload Files
                                        </h6>
                                        <p class="mb-0 small">
                                            Drop or click to upload transcoded video files, M3U8 playlists, and any
                                            other content.
                                            You can also drop your original video file here for direct upload without
                                            transcoding.
                                        </p>
                                    </div>
                                    <upload-everywhere :account="account" :saccountapi="spkapi" :mypfp="mypfp"
                                        :protocol="protocol" :stats="spkStats" :spkapi="spkapi"
                                        :external-drop="{ files: videoFilesToUpload, targetPath: null }"
                                        teleportref="#video-upload-area" @tosign="sendIt($event)"
                                        @done="handleVideoUploadComplete($event)"
                                        @update:external-drop="videoFilesToUpload = $event.files">
                                    </upload-everywhere>

                                    <!-- Upload area for teleporting -->
                                    <div id="video-upload-area" class="mt-3"></div>

                                    <!-- Video Preview Section -->
                                    <div v-if="transcodePreview.available" class="card mt-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fa-solid fa-play fa-fw me-2"></i>
                                                Transcode Preview
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Select Resolution:</label>
                                                        <select v-model="transcodePreview.selectedResolution"
                                                            @change="onPreviewResolutionChange()" class="form-select">
                                                            <option v-for="res in transcodePreview.resolutions"
                                                                :key="res.resolution" :value="res">
                                                                {{res.resolution}}p
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <video v-if="transcodePreview.videoSrc"
                                                        :src="transcodePreview.videoSrc" controls class="w-100"
                                                        style="max-height: 300px;"
                                                        @loadstart="setupHLSPlayer($event.target)">
                                                        Your browser does not support the video tag.
                                                    </video>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fa-solid fa-info-circle fa-fw me-1"></i>
                                                    This preview shows the transcoded video at the selected resolution.
                                                    Upload to make it available on IPFS.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 360 dApp Asset Management (Only show for 360 posts) -->
                <div v-if="postCustom_json.vrHash == 'QmcAkxXzczkzUJWrkWNhkJP9FF1L9Lu5sVCrUFtAZvem3k'"
                    class="accordion border-white-50 rounded mt-3" id="assetAccordion">
                    <div class="accordion-item bg-img-none bg-dark-1">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#assetManager" aria-expanded="true" aria-controls="assetManager">
                                <i class="fa-solid fa-shapes fa-fw me-2"></i>360 Asset Management
                            </button>
                        </h2>
                        <div id="assetManager" class="accordion-collapse collapse show"
                            data-bs-parent="#assetAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <assets-vue :assets="postCustom_json.assets"
                                            @updateassets="postCustom_json.assets = $event;dluxMock()"
                                            @setdapp="postCustom_json.vrHash = $event" :types="types" />
                                    </div>
                                    <div class="col-md-6">
                                        <!-- 360 Preview -->
                                        <div class="position-relative">
                                            <div
                                                class="d-flex w-100 justify-content-end align-items-center p-2 overlay position-absolute top-0 start-50 translate-middle-x">
                                                <div class="form-check form-switch form-switch-lg me-2">
                                                    <input class="form-check-input bg-blur-darkg" type="checkbox"
                                                        role="switch" id="flexSwitchCheckChecked" v-model="showLine"
                                                        title="Horizon Line">
                                                </div>
                                                <button class="btn btn-dark bg-blur-darkg border-0" title="Reset Camera"
                                                    @click="resetCamera()"><i
                                                        class="fa-solid fa-camera-rotate"></i></button>
                                            </div>
                                            <hr style="border: 5px solid red;" :class="{'invisible': !showLine}"
                                                class="overlay m-0 w-100 position-absolute top-50 start-0 translate-middle-y" />
                                            <div class="ratio ratio-1x1 frame-360">
                                                <iframe ref="aframePreview" id="aframePreview"
                                                    :src="'https://ipfs.dlux.io/ipfs/' + postCustom_json.vrHash"
                                                    frameborder="0"
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                    allowfullscreen></iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SPK Network IPFS Drive -->
                <div class="accordion border-white-50 rounded mt-3" id="accordionExample">
                    <div class="accordion-item bg-img-none bg-dark-1">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#ipfsDrive" aria-expanded="false" aria-controls="ipfsDrive">
                                <i class="fa-solid fa-hard-drive fa-fw me-2"></i>SPK Network IPFS Drive
                            </button>
                        </h2>
                        <div id="ipfsDrive" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <contract-vue v-if="account" :nodeview="false" :account="account" :mypfp="mypfp"
                                    :protocol="protocol.broca" :stats="spkStats" @tosign="toSign = $event"
                                    :prop_contracts="contracts" :accountinfo="accountinfo" :spkapi="spkapi"
                                    @done="getSapi" :postpage="true"
                                    @add-to-post="fileToAddToPost = $event"></contract-vue>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Collaborative Documents Section -->
                <div class="accordion border-white-50 rounded mt-3" id="collaborationAccordion">
                    <div class="accordion-item bg-img-none bg-dark-1">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collaborativeDocs" aria-expanded="false" aria-controls="collaborativeDocs">
                                <i class="fa-solid fa-users fa-fw me-2"></i>Collaborative Documents
                            </button>
                        </h2>
                        <div id="collaborativeDocs" class="accordion-collapse collapse" data-bs-parent="#collaborationAccordion">
                            <div class="accordion-body">
                                <collaborative-docs v-if="account" 
                                    :account="account" 
                                    :auth-headers="collaborationAuthHeaders"
                                    @open-collaborative-doc="openCollaborativeDocument"
                                    @request-auth-headers="ensureCollaborationAuth"
                                    @permission-change="handleCollaborativePermissionChange"
                                    @load-document-content="loadDocumentIntoPost"></collaborative-docs>
                                <div v-else class="text-center text-muted py-4">
                                    <i class="fas fa-sign-in-alt fa-2x mb-3"></i>
                                    <p>Please log in to access collaborative documents.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Collaborative Post Editor (when in collaborative mode) -->
                <div v-if="isCollaborativeMode" class="mt-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fa-solid fa-users fa-fw me-2"></i>Collaborative Post Editor</h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @click="exitCollaborativeMode">
                                <i class="fas fa-times me-1"></i>Exit Collaboration
                            </button>
                        </div>
                        <div class="card-body">
                            <collaborative-post-editor 
                                :account="account"
                                :show-collaboration="true"
                                :collaborative-doc="collaborativeDocument"
                                :collaboration-config="{ 
                                    authToken: collaborationAuthHeaders['x-signature'],
                                    username: account,
                                    userColor: '#' + Math.floor(Math.random()*16777215).toString(16)
                                }"
                                :can-post="canPostFromCollaboration"
                                :initial-data="collaborativeDocumentData"
                                @data-changed="handleCollaborativePostData"
                                @publish-post="handleCollaborativePublish" />
                        </div>
                    </div>
                </div>
                
                <!-- Regular Post Details (when not in collaborative mode) -->
                <div v-if="!isCollaborativeMode" class="mt-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-pen-to-square fa-fw me-2"></i>Post Details</h5>
                        </div>
                        <div class="card-body">
                            <post-vue :account="account" :prop_json="postCustom_json" :prop_bens="postBens"
                                @tosign="sendIt($event)" :file_to_add="fileToAddToPost"
                                :is-collaborative-mode="isCollaborativeMode"
                                :collaborative-document="collaborativeDocument"
                                :collaboration-auth-headers="collaborationAuthHeaders"
                                :collaborative-permission="collaborativePermission"
                                :can-post-from-collaboration="canPostFromCollaboration"
                                @requestCollaboration="requestCollaboration" />
                        </div>
                    </div>
                </div>
            </div>
            <!-- SPK Wallet Modal -->
            <div class="modal modal-xl fade" id="spkWalletModal" tabindex="-1" aria-labelledby="spkWalletModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content bg-dark-90">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="spkWalletModalLabel">SPK Testnet Wallet</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <spk-vue node="false" :account="account" @tosign="sendIt($event);log($event)" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sponsored Contract -->
            <div class="modal fade" id="sponsoredModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content bg-darker text-white">
                        <div class="modal-header">
                            <h5 class="modal-title">Sponsored Contracts</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body text-start">
                            <div v-for="spon in services">
                                <button :disabled="spon.channel" @click="petitionForContract(spon.provider)"
                                    class="btn btn-lg text-white btn-outline-primary w-100 border d-flex justify-content-between align-items-center"><span
                                        class="lead">@{{spon.provider}}</span><span
                                        class="small text-warning">{{spon.memo}}</span></button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                        </div>

                    </div>
                </div>
            </div>
    </div>
    </main>
    <!-- Footer -->
    <foot-vue />
    </div>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script>function deepLink(link) { }</script>
    <script>
        // Add JavaScript to toggle collapse on <tr> click
        document.addEventListener('DOMContentLoaded', function () {
            var trElements = document.querySelectorAll('.table tbody tr[data-bs-toggle="collapse"]');
            trElements.forEach(function (tr) {
                tr.addEventListener('click', function () {
                    var target = document.querySelector(this.getAttribute('href'));
                    if (target.classList.contains('show')) {
                        target.classList.remove('show');
                        target.setAttribute('aria-expanded', 'false');
                    } else {
                        target.classList.add('show');
                        target.setAttribute('aria-expanded', 'true');
                    }
                });
            });
        });
    </script>
    <script>
        var video_page = true
    </script>
    <!-- Load the collaboration bundle (includes Y.js) -->
    <script src="/packages/hocuspocus-provider.bundle.js"></script>
    <script>
        // Verify that the collaboration bundle is loaded and prevent Y.js conflicts
        setTimeout(() => {
            console.log('CollaborationBundle available:', !!window.CollaborationBundle);
            console.log('Global Y.js available:', !!window.Y);
            console.log('HocuspocusProvider available:', !!window.HocuspocusProvider);
            
            if (window.CollaborationBundle) {
                console.log('CollaborationBundle contents:', Object.keys(window.CollaborationBundle));
                console.log('HocuspocusProvider from bundle:', typeof window.CollaborationBundle.HocuspocusProvider);
                console.log('Y from bundle:', typeof window.CollaborationBundle.Y);
                console.log('Y.Doc constructor from bundle:', typeof window.CollaborationBundle.Y.Doc);
                
                // Ensure global Y.js is available for compatibility
                if (!window.Y && window.CollaborationBundle.Y) {
                    window.Y = window.CollaborationBundle.Y;
                    console.log('✅ Y.js made available globally from CollaborationBundle');
                }
                
                // Test WebSocket URL access
                console.log('Testing WebSocket URL: wss://data.dlux.io/ws/payment-monitor');
            } else {
                console.error('❌ CollaborationBundle not loaded - collaboration will not work');
            }
        }, 100);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</body>

</html>